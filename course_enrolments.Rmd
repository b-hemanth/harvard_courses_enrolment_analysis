---
title: "Biggest Departmental Changes in Enrolments at Harvard"
author: "Hemanth Bharatha Chakravarthy"
date: "4/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = "H", fig.align = "center")
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(readxl)
library(janitor)
```

```{r download_data}
download.file(
  url = "https://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_2.28.19.xlsx",
  destfile = "spring_2019.xlsx",
  mode = "wb")

download.file(
  url = "https://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_03.06.18.xlsx",
  destfile = "spring_2018.xlsx",
  mode = "wb")

spring_19 <- read_excel("spring_2019.xlsx", skip = 3) %>% 
  clean_names() %>% 
  filter(!is.na(u_grad), !is.na(course_title), u_grad != 0) %>% 
  select(course_title, course_name, course_department, u_grad)

spring_18 <- read_excel("spring_2018.xlsx", skip = 3) %>% 
  clean_names() %>% 
  filter(!is.na(u_grad), !is.na(course_title), u_grad != 0) %>% 
  select(course_title, course_name, course_department, u_grad)

fs::file_delete(c("spring_2018.xlsx", "spring_2019.xlsx"))
```

```{r data_pre-processing}
spring_19_18 <- spring_19 %>%
  full_join(spring_18, by = "course_title") %>%
  filter(course_department.x == course_department.y) %>%
  rename(course_department = course_department.x,
         enrol_19 = u_grad.x, 
         enrol_18 = u_grad.y) %>% 
  distinct() %>% 
  select(-course_department.y, -course_name.y)
```

```{r department_analysis}
plot_df <- spring_19_18 %>% 
  filter(course_department != "Expository Writing") %>% 
  group_by(course_department) %>% 
  summarise(sum_19 = sum(enrol_19), sum_18 = sum(enrol_18)) %>% 
  mutate(
    change = sum_19 - sum_18,
    absolute_change = abs(change)
    ) %>% 
  arrange(desc(change)) %>% 
  top_n(10) %>% 
  select(-absolute_change) %>% 
  mutate(
    course_department = as.factor(course_department),
    course_department = recode_factor(course_department,
                                      `Romance Languages & Lit` = "Romance Languages & Literature",
                                      `African & African Amer Studies` = "African & African American Studies",
                                      `East Asian Langs & Civ` = "East Asian Languages & Civilization")
    )

```

# The Plot
```{r plot}
plot_df %>% 
  ggplot(aes(x = course_department, y = change, color = course_department)) +
  geom_point() + 
  geom_segment(aes(x = course_department, xend = course_department, y = 0, yend = change)) +
  labs(
    title = "Top 10 Harvard Departments* with Biggest Changes
    in Course Enrolments",
    subtitle = "Changes Measured Between Spring 2018 and Spring 2019",
    caption = "*Excluding Expository Writing
    Data from Harvard Registrar",
    x = "Department",
    y = "Change in Enrolment", 
    color = "Department"
  ) +
  theme(
    axis.text.x=element_blank()
  ) 


```


